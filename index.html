<!DOCTYPE html>
<html lang="ja" class="">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>会話相手AIプリセット・ハブ</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.39.4/dist/umd/supabase.js"></script>
  <style>
    /* Dark mode support: toggle on <html> element */
    :root { color-scheme: light dark; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-200">
  <!-- Header -->
  <header class="sticky top-0 z-20 bg-white/80 dark:bg-gray-800/80 backdrop-blur border-b border-gray-200 dark:border-gray-700">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl sm:text-2xl font-bold">会話相手AIプリセット・ハブ</h1>
      <div class="flex items-center space-x-2">
        <button id="openModalBtn" class="px-3 py-1.5 text-sm rounded border bg-white dark:bg-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600">投稿する</button>
        <button id="themeToggle" class="px-3 py-1.5 text-sm rounded border bg-white dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600">テーマ</button>
      </div>
    </div>
  </header>
  <!-- Main content -->
  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Search & sort -->
    <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
      <input id="searchInput" type="text" placeholder="検索: 名前 / 特徴 / MBTI / 役割" class="flex-1 border rounded-xl px-3 py-2" />
      <select id="sortSelect" class="border rounded-xl px-3 py-2">
        <option value="popular">人気順</option>
        <option value="newest">新着順</option>
        <option value="copies">コピー数</option>
      </select>
    </div>
    <!-- Tag filter -->
    <div id="tagFilter" class="flex flex-wrap gap-2 my-4"></div>
    <!-- Presets list -->
    <div id="presetsList" class="grid gap-4 md:grid-cols-2"></div>
  </main>
  <!-- Footer -->
  <footer class="text-center text-xs text-gray-500 dark:text-gray-400 py-8">&copy; <span id="year"></span> Conversation Partner Preset Hub</footer>
  <!-- Modal for posting -->
  <div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-2xl overflow-y-auto max-h-screen">
      <div class="flex justify-between mb-4">
        <h2 class="text-lg font-semibold">新規プリセットを投稿</h2>
        <button id="closeModalBtn" class="text-sm px-2 py-1 rounded border">閉じる</button>
      </div>
      <form id="postForm" class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
        <label class="grid gap-1">
          <span class="text-xs text-gray-500">名前*</span>
          <input name="name" required class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" />
        </label>
        <label class="grid gap-1">
          <span class="text-xs text-gray-500">タイトル</span>
          <input name="title" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" />
        </label>
        <label class="grid gap-1">
          <span class="text-xs text-gray-500">画像URL</span>
          <input name="image" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="https://..." />
        </label>
        <!-- 画像ファイルアップロード: ここでローカルの画像ファイルを選択できます。入力がある場合はURLより優先されます -->
        <label class="grid gap-1">
          <span class="text-xs text-gray-500">画像ファイル</span>
          <input type="file" name="imageFile" accept="image/*" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" />
        </label>
        <label class="grid gap-1">
          <span class="text-xs text-gray-500">MBTI</span>
          <input name="mbti" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="例: ENFP" />
        </label>
        <label class="grid gap-1">
          <span class="text-xs text-gray-500">性別</span>
          <input name="gender" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="男性/女性/その他/未設定" />
        </label>
        <label class="grid gap-1">
          <span class="text-xs text-gray-500">口調</span>
          <input name="tone" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="丁寧/カジュアル/厳しめ 等" />
        </label>
        <label class="grid gap-1">
          <span class="text-xs text-gray-500">雰囲気</span>
          <input name="brightness" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="明るめ/落ち着き 等" />
        </label>
        <label class="grid gap-1 sm:col-span-2">
          <span class="text-xs text-gray-500">目的</span>
          <input name="goal" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="相談/雑談/学習 等" />
        </label>
        <label class="grid gap-1 sm:col-span-2">
          <span class="text-xs text-gray-500">特徴</span>
          <textarea name="traits" rows="2" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="例: 優しい・共感的・聞き上手"></textarea>
        </label>
        <label class="grid gap-1 sm:col-span-2">
          <span class="text-xs text-gray-500">ペルソナ概要</span>
          <textarea name="persona" rows="2" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="1-3文で"></textarea>
        </label>
        <label class="grid gap-1 sm:col-span-2">
          <span class="text-xs text-gray-500">タグ (カンマ区切り)</span>
          <input name="tags" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="優しい,共感,相談" />
        </label>
        <label class="grid gap-1 sm:col-span-2">
          <span class="text-xs text-gray-500">スタータープロンプト*</span>
          <textarea name="starterPrompt" rows="3" required class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="そのままコピーできる指示文"></textarea>
        </label>
        <!-- サンプル会話を1つのフィールドに統合 -->
        <label class="grid gap-1 sm:col-span-2">
          <span class="text-xs text-gray-500">サンプル会話</span>
          <textarea name="sampleConversation" rows="4" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="例: ユーザーとAIの会話を自由に記入"></textarea>
        </label>
      </form>
      <div class="mt-4 flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
        <span>※ 画像は権利に注意。投稿は利用規約/モデレーション対象。</span>
        <button id="submitBtn" class="px-4 py-2 text-sm rounded bg-black text-white dark:bg-white dark:text-black">投稿する</button>
      </div>
    </div>
  </div>
  <!-- Script -->
  <script>
    (() => {
      // Supabase connection: embed the provided credentials
      const SUPABASE_URL = 'https://izmqiahahcsifhjtpgtd.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6bXFpYWhhaGNzaWZoanRwZ3RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MTI4NDIsImV4cCI6MjA3NDI4ODg0Mn0.LNnuAlfOekakZCVyGC7IA_NgYfy1BGe34PcxS8miAMw';
      const supabase = (typeof window.supabase !== 'undefined') ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
      // Local storage helpers
      const getLS = (key, def) => {
        try { const s = localStorage.getItem(key); return s ? JSON.parse(s) : def; } catch (e) { return def; }
      };
      const setLS = (key, val) => {
        try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
      };
      // Seeds for fallback
      const seeds = [
        {
          id: 'yukari',
          name: 'ゆかり',
          title: '優しい聞き役の友人',
          image: 'https://images.unsplash.com/photo-1560250097-0b93528c311a?auto=format&fit=crop&w=800&q=60',
          persona: '相手の気持ちに寄り添う癒やし系。安心して話せる雰囲気をつくる。',
          traits: '優しい・共感的・聞き上手',
          goal: '感情整理／安心して話す',
          mbti: 'ISFJ',
          gender: '女性',
          tone: '丁寧/やわらか',
          brightness: '明るめ',
          tags: ['優しい','共感','相談'],
          starterPrompt: 'あなたは「優しい聞き役の友人」です。\n- 共感→要約→オープン質問の順で進める\n- 評価や断定は避ける\n- 必要なときだけ提案を1つまで',
          sampleDialog: [
            { role: 'user', text: '研究が進まなくて焦る。' },
            { role: 'assistant', text: '焦りが強いんだね。どの場面で一番強く出る？一緒に区切って考えてみよう。' }
          ],
          likes: 21, copies: 58, createdAt: Date.now() - 1000 * 60 * 60 * 24 * 9
        },
        {
          id: 'takeshi',
          name: 'たけし',
          title: 'ストイック現実コーチ',
          image: 'https://images.unsplash.com/photo-1519345182560-3f2917c472ef?auto=format&fit=crop&w=800&q=60',
          persona: '遠慮なく核心を突く。目標達成のために最短の行動を示す。',
          traits: '厳しめ・論理的・短文',
          goal: '意思決定／行動計画',
          mbti: 'ENTJ',
          gender: '男性',
          tone: '断定/簡潔',
          brightness: '中庸',
          tags: ['厳しめ','論理','コーチング'],
          starterPrompt: 'あなたは「ストイックな現実コーチ」です。\n- 形式: 結論(1行)→理由(最大3)→次の3ステップ\n- 迷いが多い場合は判断軸を3つに限定\n- 医療/法律/投資は一般情報のみ',
          sampleDialog: [
            { role: 'user', text: '転職迷い中。決めきれない。' },
            { role: 'assistant', text: '結論: 今週末に決めろ。理由: 情報過多/軸不明/期限無。次の3ステップ: 軸=年収/裁量/成長、5段階比較、日曜18時に結論。' }
          ],
          likes: 35, copies: 92, createdAt: Date.now() - 1000 * 60 * 60 * 24 * 6
        }
      ];
      // State
      let presets = [];
      let likes = getLS('cpp_likes', {});
      let copies = getLS('cpp_copies', {});
      let favorites = getLS('cpp_fav', {});
      let searchQuery = '';
      let selectedTags = [];
      let sortMode = 'popular';
      // Elements
      const listEl = document.getElementById('presetsList');
      const tagFilterEl = document.getElementById('tagFilter');
      const searchInput = document.getElementById('searchInput');
      const sortSelect = document.getElementById('sortSelect');
      const modal = document.getElementById('modal');
      const openModalBtn = document.getElementById('openModalBtn');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const postForm = document.getElementById('postForm');
      const submitBtn = document.getElementById('submitBtn');
      const themeToggle = document.getElementById('themeToggle');
      // Load initial data
      async function loadPresets() {
        presets = [...seeds];
        if (supabase) {
          try {
            const { data, error } = await supabase
              .from('presets')
              .select('*')
              .eq('status', 'public')
              .order('created_at', { ascending: false });
            if (!error && Array.isArray(data)) {
              const converted = data.map((row) => ({
                id: row.id || Math.random().toString(36).slice(2),
                name: row.name,
                title: row.title,
                image: row.image_url || '',
                persona: row.persona,
                traits: row.traits,
                goal: row.goal,
                mbti: row.mbti,
                gender: row.gender,
                tone: row.tone,
                brightness: row.brightness,
                tags: row.tags || [],
                starterPrompt: row.prompt,
                sampleDialog: row.sample || [],
                likes: 0,
                copies: 0,
                createdAt: new Date(row.created_at).getTime(),
              }));
              presets = [...converted, ...presets];
            }
          } catch (e) {
            console.warn('Supabaseからの取得に失敗', e);
          }
        }
        render();
        updateTagFilter();
      }
      // Render presets list
      function render() {
        const filtered = presets.filter((p) => {
          const q = searchQuery.trim().toLowerCase();
          const qHit = !q || [p.name, p.title, p.persona, p.traits, p.goal, p.mbti, p.tone].join(' ').toLowerCase().includes(q);
          const tagHit = selectedTags.length === 0 || selectedTags.every((t) => p.tags.includes(t));
          return qHit && tagHit;
        }).sort((a, b) => {
          if (sortMode === 'popular') {
            const aScore = (a.likes || 0) + (a.copies || 0);
            const bScore = (b.likes || 0) + (b.copies || 0);
            return bScore - aScore;
          }
          if (sortMode === 'newest') {
            return b.createdAt - a.createdAt;
          }
          if (sortMode === 'copies') {
            return (b.copies || 0) - (a.copies || 0);
          }
          return 0;
        });
        listEl.innerHTML = '';
        if (filtered.length === 0) {
          listEl.innerHTML = '<div class="text-gray-500 dark:text-gray-400 py-12">該当するプリセットがありません。</div>';
          return;
        }
        filtered.forEach((p) => {
          const card = document.createElement('div');
          // お気に入りの場合は青い枠を付ける
          card.className = 'rounded-2xl overflow-hidden shadow-md flex flex-col md:flex-row ' + (favorites[p.id] ? 'border-blue-500' : 'border');
          // Image
          const imgDiv = document.createElement('div');
          imgDiv.className = 'md:w-1/3 h-40 md:h-auto overflow-hidden';
          const img = document.createElement('img');
          img.src = p.image || 'https://placehold.co/400x300?text=No+Image';
          img.alt = p.name;
          img.className = 'object-cover w-full h-full';
          imgDiv.appendChild(img);
          // Content
          const cont = document.createElement('div');
          cont.className = 'p-4 flex-1 flex flex-col';
          const header = document.createElement('div');
          header.className = 'flex justify-between items-start mb-2';
          const nameEl = document.createElement('div');
          nameEl.innerHTML = `<h3 class="text-lg font-semibold">${p.name}</h3><p class="text-xs text-gray-600 dark:text-gray-300">${p.title || ''}</p>`;
          header.appendChild(nameEl);
          const saveBtn = document.createElement('button');
          saveBtn.className = 'text-xs px-2 py-1 rounded border';
          saveBtn.textContent = favorites[p.id] ? '保存済' : '保存';
          saveBtn.addEventListener('click', () => {
            // お気に入り状態をトグル
            favorites[p.id] = !favorites[p.id];
            setLS('cpp_fav', favorites);
            // 全体を再描画してボタン文字とカード枠を更新
            render();
          });
          header.appendChild(saveBtn);
          cont.appendChild(header);
          // Persona & meta
          const meta = document.createElement('div');
          meta.className = 'flex flex-wrap gap-2 text-xs text-gray-600 dark:text-gray-300 mb-2';
          meta.innerHTML =
            `<span>${p.persona}</span>` +
            (p.mbti ? `<span class="px-2 py-0.5 border rounded">MBTI: ${p.mbti}</span>` : '') +
            (p.gender ? `<span class="px-2 py-0.5 border rounded">${p.gender}</span>` : '') +
            (p.tone ? `<span class="px-2 py-0.5 border rounded">口調: ${p.tone}</span>` : '') +
            (p.brightness ? `<span class="px-2 py-0.5 border rounded">雰囲気: ${p.brightness}</span>` : '');
          cont.appendChild(meta);
          // Traits and goal
          if (p.traits) {
            const traitsEl = document.createElement('p');
            traitsEl.className = 'text-sm mb-1';
            traitsEl.textContent = `特徴: ${p.traits}`;
            cont.appendChild(traitsEl);
          }
          if (p.goal) {
            const goalEl = document.createElement('p');
            goalEl.className = 'text-sm mb-1';
            goalEl.textContent = `目的: ${p.goal}`;
            cont.appendChild(goalEl);
          }
          // Tags
          if (p.tags && p.tags.length) {
            const tagsDiv = document.createElement('div');
            tagsDiv.className = 'flex flex-wrap gap-1 mb-2';
            p.tags.forEach((t) => {
              const tag = document.createElement('span');
              tag.className = 'px-2 py-0.5 bg-gray-100 dark:bg-gray-700 text-xs rounded';
              tag.textContent = `#${t}`;
              tagsDiv.appendChild(tag);
            });
            cont.appendChild(tagsDiv);
          }
          // Buttons
          const btnRow = document.createElement('div');
          btnRow.className = 'mt-auto flex flex-wrap items-center gap-2 text-xs';
          // Like button
          const likeBtn = document.createElement('button');
          likeBtn.className = 'flex items-center gap-1 px-3 py-1 rounded border';
          likeBtn.innerHTML = `❤ ${p.likes || 0}`;
          if (likes[p.id]) {
            likeBtn.classList.add('text-red-600');
          }
          likeBtn.addEventListener('click', () => {
            if (likes[p.id]) {
              // toggle off
              delete likes[p.id];
              p.likes = Math.max(0, (p.likes || 0) - 1);
              likeBtn.classList.remove('text-red-600');
            } else {
              likes[p.id] = true;
              p.likes = (p.likes || 0) + 1;
              likeBtn.classList.add('text-red-600');
            }
            setLS('cpp_likes', likes);
            likeBtn.innerHTML = `❤ ${p.likes}`;
            render();
          });
          btnRow.appendChild(likeBtn);
          // Copy button
          const copyBtn = document.createElement('button');
          copyBtn.className = 'flex items-center gap-1 px-3 py-1 rounded border';
          copyBtn.innerHTML = '📋 コピー';
          copyBtn.addEventListener('click', async () => {
            try {
              await navigator.clipboard.writeText(p.starterPrompt);
              // コピー回数を増やす（1クリックごとにカウントアップ）
              p.copies = (p.copies || 0) + 1;
              // コピー状態を保存（複数回コピー可）
              copies[p.id] = true;
              setLS('cpp_copies', copies);
              // 一時的にコピー済みと表示
              copyBtn.innerHTML = '✔ コピー済み';
              // 1秒後に元に戻す
              setTimeout(() => { copyBtn.innerHTML = '📋 コピー'; }, 1200);
              render();
            } catch (e) {
              console.warn('コピーに失敗', e);
            }
          });
          btnRow.appendChild(copyBtn);
          // Toggle prompt
          const toggleBtn = document.createElement('button');
          toggleBtn.className = 'px-3 py-1 rounded border';
          toggleBtn.textContent = 'プロンプトを見る';
          btnRow.appendChild(toggleBtn);
          cont.appendChild(btnRow);
          // Hidden prompt
          const promptDiv = document.createElement('div');
          promptDiv.className = 'mt-2 text-xs bg-gray-50 dark:bg-gray-700 rounded p-3 border hidden whitespace-pre-wrap';
          // プロンプトの下にサンプル会話を表示。sampleConversationがあればそれを、その次に従来のsampleDialog形式にも対応
          let sampleText = '';
          if (p.sampleConversation) {
            sampleText = p.sampleConversation;
          } else if (p.sampleDialog && Array.isArray(p.sampleDialog) && p.sampleDialog.length) {
            sampleText = p.sampleDialog.map((d) => {
              const prefix = d.role === 'user' ? 'ユーザー: ' : d.role === 'assistant' ? 'AI: ' : '';
              return prefix + d.text;
            }).join('\n');
          }
          promptDiv.textContent = p.starterPrompt + '\n\n' + sampleText;
          cont.appendChild(promptDiv);
          toggleBtn.addEventListener('click', () => {
            const isOpen = !promptDiv.classList.contains('hidden');
            promptDiv.classList.toggle('hidden');
            toggleBtn.textContent = isOpen ? 'プロンプトを見る' : 'プロンプトを隠す';
          });
          // Append to card
          card.appendChild(imgDiv);
          card.appendChild(cont);
          listEl.appendChild(card);
        });
      }
      function updateTagFilter() {
        const all = new Set();
        presets.forEach((p) => (p.tags || []).forEach((t) => all.add(t)));
        const tags = Array.from(all).sort();
        tagFilterEl.innerHTML = '';
        if (tags.length === 0) return;
        tags.forEach((t) => {
          const chip = document.createElement('button');
          chip.className = 'px-2 py-1 rounded-full border text-xs ' + (selectedTags.includes(t) ? 'bg-black text-white dark:bg-white dark:text-black' : 'bg-white dark:bg-gray-700');
          chip.textContent = '#' + t;
          chip.addEventListener('click', () => {
            if (selectedTags.includes(t)) {
              selectedTags = selectedTags.filter((x) => x !== t);
            } else {
              selectedTags.push(t);
            }
            render();
            updateTagFilter();
          });
          tagFilterEl.appendChild(chip);
        });
        if (selectedTags.length > 0) {
          const clearBtn = document.createElement('button');
          clearBtn.className = 'px-2 py-1 rounded-full border text-xs bg-red-100 dark:bg-red-700 text-red-600';
          clearBtn.textContent = 'クリア';
          clearBtn.addEventListener('click', () => {
            selectedTags = [];
            render();
            updateTagFilter();
          });
          tagFilterEl.appendChild(clearBtn);
        }
      }
      // Event listeners
      searchInput.addEventListener('input', (e) => {
        searchQuery = e.target.value;
        render();
      });
      sortSelect.addEventListener('change', (e) => {
        sortMode = e.target.value;
        render();
      });
      openModalBtn.addEventListener('click', () => { modal.classList.remove('hidden'); });
      closeModalBtn.addEventListener('click', () => { modal.classList.add('hidden'); });
      submitBtn.addEventListener('click', async () => {
        const formData = new FormData(postForm);
        const payload = {
          id: 'id-' + Math.random().toString(36).slice(2),
          name: formData.get('name').trim(),
          title: formData.get('title').trim(),
          image: formData.get('image').trim(),
          persona: formData.get('persona').trim(),
          traits: formData.get('traits').trim(),
          goal: formData.get('goal').trim(),
          mbti: formData.get('mbti').trim(),
          gender: formData.get('gender').trim(),
          tone: formData.get('tone').trim(),
          brightness: formData.get('brightness').trim(),
          tags: formData.get('tags').split(',').map((s) => s.trim()).filter(Boolean),
          starterPrompt: formData.get('starterPrompt').trim(),
          // サンプル会話は1つのテキストを行ごとに分割して配列化し、表示用に文字列も保持
          sampleConversation: formData.get('sampleConversation').trim(),
          sampleDialog: (() => {
            const txt = formData.get('sampleConversation').trim();
            if (!txt) return [];
            return txt.split('\n').map((line) => ({ role: 'user', text: line }));
          })(),
          likes: 0,
          copies: 0,
          createdAt: Date.now(),
        };
        // 画像ファイルが選択されている場合は、ファイルをDataURLに変換してURL入力より優先します
        const imageFile = formData.get('imageFile');
        if (imageFile && imageFile instanceof File && imageFile.size > 0) {
          try {
            const dataUrl = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result);
              reader.onerror = (err) => reject(err);
              reader.readAsDataURL(imageFile);
            });
            payload.image = dataUrl;
          } catch (e) {
            console.warn('画像ファイルの読み込みに失敗しました', e);
          }
        }
        if (!payload.name || !payload.starterPrompt) {
          alert('必須項目を入力してください。');
          return;
        }
        // Insert into Supabase if available
        if (supabase) {
          try {
            const { error } = await supabase.from('presets').insert({
              name: payload.name,
              title: payload.title,
              image_url: payload.image,
              persona: payload.persona,
              traits: payload.traits,
              goal: payload.goal,
              mbti: payload.mbti,
              gender: payload.gender,
              tone: payload.tone,
              brightness: payload.brightness,
              tags: payload.tags,
              prompt: payload.starterPrompt,
              sample: payload.sampleDialog,
              status: 'public',
            });
            if (error) throw error;
          } catch (e) {
            console.warn('Supabase保存に失敗、ローカルのみ', e);
          }
        }
        // Insert locally and re-render
        presets.unshift(payload);
        render();
        updateTagFilter();
        postForm.reset();
        modal.classList.add('hidden');
      });
      // Theme toggle
      themeToggle.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
      });
      // Set current year
      document.getElementById('year').textContent = new Date().getFullYear();
      // Load presets
      loadPresets();
    })();
  </script>
</body>
</html>