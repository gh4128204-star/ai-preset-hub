<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>会話相手AIプリセット・ハブ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM (development builds) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Framer Motion -->
    <script crossorigin src="https://unpkg.com/framer-motion/dist/framer-motion.umd.js"></script>
    <!-- Lucide React Icons -->
    <script crossorigin src="https://unpkg.com/lucide-react@latest/dist/lucide-react.umd.js"></script>
    <!-- Supabase JS (UMD) -->
    <script crossorigin src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- Babel for JSX transformation in the browser -->
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      /* Custom scrollbars for dark mode */
      body.dark::-webkit-scrollbar {
        width: 8px;
      }
      body.dark::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
      }
      body.dark::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
      // -----------------------------------------------------------
      // Configuration: Supabase credentials and admin email
      // Provided by the user
      const SUPABASE_URL = "https://izmqiahahcsifhjtpgtd.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6bXFpYWhhaGNzaWZoanRwZ3RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MTI4NDIsImV4cCI6MjA3NDI4ODg0Mn0.LNnuAlfOekakZCVyGC7IA_NgYfy1BGe34PcxS8miAMw";
      const ADMIN_EMAIL = "";

      // Initialize Supabase client if credentials are provided
      const supabase = (typeof window !== 'undefined' && window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY)
        ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        : null;

      // -----------------------------------------------------------
      // Import required libraries from global objects
      const { useState, useEffect, useMemo } = React;
      const { motion } = Motion;
      const {
        Copy,
        Check,
        Search,
        Filter,
        MessageSquareHeart,
        Sparkles,
        Sun,
        Moon,
        Heart,
        HeartHandshake,
        TrendingUp,
        Clock,
        Plus,
        Image: ImageIcon,
        LogIn,
        LogOut,
        Mail,
      } = LucideReact;

      // Utility: compose class names
      const classNames = (...c) => c.filter(Boolean).join(" ");
      const now = () => Date.now();

      // Dark mode hook
      function useDarkMode() {
        const [dark, setDark] = useState(false);
        useEffect(() => {
          // Apply dark class to <html> element
          document.documentElement.classList.toggle("dark", dark);
        }, [dark]);
        return { dark, setDark };
      }

      // LocalStorage hook
      function useLocalStorage(key, initial) {
        const [val, setVal] = useState(() => {
          try {
            const s = localStorage.getItem(key);
            return s ? JSON.parse(s) : initial;
          } catch {
            return initial;
          }
        });
        useEffect(() => {
          try {
            localStorage.setItem(key, JSON.stringify(val));
          } catch {}
        }, [key, val]);
        return [val, setVal];
      }

      // Seed data
      const SEED = [
        {
          id: "yukari",
          name: "ゆかり",
          title: "優しい聞き役の友人",
          image: "https://images.unsplash.com/photo-1560250097-0b93528c311a?auto=format&fit=crop&w=800&q=60",
          persona: "相手の気持ちに寄り添う癒やし系。安心して話せる雰囲気をつくる。",
          traits: "優しい・共感的・聞き上手",
          goal: "感情整理／安心して話す",
          mbti: "ISFJ",
          gender: "女性",
          tone: "丁寧/やわらか",
          brightness: "明るめ",
          tags: ["優しい", "共感", "相談"],
          starterPrompt: `あなたは『優しい聞き役の友人』です。\n- 共感→要約→オープン質問の順で進める\n- 評価や断定は避ける\n- 必要なときだけ提案を1つまで`,
          sampleDialog: [
            { role: "user", text: "研究が進まなくて焦る。" },
            { role: "assistant", text: "焦りが強いんだね。どの場面で一番強く出る？一緒に区切って考えてみよう。" },
          ],
          likes: 21,
          copies: 58,
          createdAt: now() - 1000 * 60 * 60 * 24 * 9,
        },
        {
          id: "takeshi",
          name: "たけし",
          title: "ストイック現実コーチ",
          image: "https://images.unsplash.com/photo-1519345182560-3f2917c472ef?auto=format&fit=crop&w=800&q=60",
          persona: "遠慮なく核心を突く。目標達成のために最短の行動を示す。",
          traits: "厳しめ・論理的・短文",
          goal: "意思決定／行動計画",
          mbti: "ENTJ",
          gender: "男性",
          tone: "断定/簡潔",
          brightness: "中庸",
          tags: ["厳しめ", "論理", "コーチング"],
          starterPrompt: `あなたは『ストイックな現実コーチ』です。\n- 形式: 結論(1行)→理由(最大3)→次の3ステップ\n- 迷いが多い場合は判断軸を3つに限定\n- 医療/法律/投資は一般情報のみ`,
          sampleDialog: [
            { role: "user", text: "転職迷い中。決めきれない。" },
            { role: "assistant", text: "結論: 今週末に決めろ。理由: 情報過多/軸不明/期限無。次の3ステップ: 軸=年収/裁量/成長、5段階比較、日曜18時に結論。" },
          ],
          likes: 35,
          copies: 92,
          createdAt: now() - 1000 * 60 * 60 * 24 * 6,
        },
      ];

      // Auth hook (only functional if supabase is set up)
      function useAuth() {
        const [session, setSession] = useState(null);
        const [loading, setLoading] = useState(true);
        const [inviteOK, setInviteOK] = useState(false);
        const [isAdmin, setIsAdmin] = useState(false);
        useEffect(() => {
          let mounted = true;
          if (!supabase) { setLoading(false); return; }
          supabase.auth.getSession().then(({ data }) => {
            if (!mounted) return;
            setSession(data.session);
            setLoading(false);
          });
          const { data: sub } = supabase.auth.onAuthStateChange((_event, sess) => {
            setSession(sess || null);
          });
          return () => {
            mounted = false;
            sub?.subscription?.unsubscribe?.();
          };
        }, []);
        useEffect(() => {
          (async () => {
            if (!session || !supabase) { setInviteOK(false); setIsAdmin(false); return; }
            const email = session.user?.email?.toLowerCase();
            setIsAdmin(!!ADMIN_EMAIL && email === ADMIN_EMAIL.toLowerCase());
            const { data, error } = await supabase
              .from('allowlist')
              .select('email')
              .eq('email', email)
              .maybeSingle();
            setInviteOK(!!data && !error);
          })();
        }, [session]);
        const signInWithEmail = async (email) => {
          if (!supabase) {
            alert('プレビューではログインは無効です（本番環境で有効化）');
            return;
          }
          const { error } = await supabase.auth.signInWithOtp({
            email,
            options: { emailRedirectTo: typeof window !== 'undefined' ? window.location.href : undefined },
          });
          if (error) throw error;
        };
        const signOut = async () => { if (supabase) await supabase.auth.signOut(); };
        return { session, loading, inviteOK, isAdmin, signInWithEmail, signOut };
      }

      // Components
      function ThemeToggle({ dark, onToggle }) {
        return (
          <button
            onClick={onToggle}
            className="inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-sm backdrop-blur bg-white/60 dark:bg-white/5 hover:bg-white/80 dark:hover:bg-white/10 transition"
            aria-label="テーマ切替"
          >
            {dark ? <Sun className="h-4 w-4" /> : <Moon className="h-4 w-4" />}
            <span className="hidden sm:inline">{dark ? "ライト" : "ダーク"}</span>
          </button>
        );
      }

      function Pill({ active, children, onClick }) {
        return (
          <button
            onClick={onClick}
            className={classNames(
              'px-3 py-1 rounded-full border text-sm',
              active
                ? 'bg-black text-white dark:bg-white dark:text-black'
                : 'bg-white/80 dark:bg-white/10 hover:bg-white/90 dark:hover:bg-white/15 backdrop-blur'
            )}
          >
            {children}
          </button>
        );
      }

      function Glass({ children, ring = 'from-violet-400/20 to-emerald-400/20' }) {
        return (
          <motion.div
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.25 }}
            className={classNames(
              'relative rounded-2xl border bg-white/60 dark:bg-white/5 backdrop-blur p-5 shadow-[0_10px_30px_-10px_rgba(0,0,0,0.25)]',
              'before:absolute before:inset-0 before:rounded-2xl before:-z-10 before:blur-xl before:bg-gradient-to-br',
              ring
            )}
          >
            {children}
          </motion.div>
        );
      }

      function CopyButton({ text, onCopied }) {
        const [copied, setCopied] = useState(false);
        return (
          <button
            onClick={async () => {
              try {
                await navigator.clipboard.writeText(text);
                setCopied(true);
                onCopied?.();
                setTimeout(() => setCopied(false), 1200);
              } catch (e) {}
            }}
            className="inline-flex items-center gap-2 rounded-lg border px-3 py-1.5 text-sm bg-white/70 dark:bg-white/10 hover:bg-white/90 dark:hover:bg-white/20 backdrop-blur"
          >
            {copied ? <Check className="h-4 w-4" /> : <Copy className="h-4 w-4" />}
            <span>{copied ? 'コピー済み' : 'プロンプトをコピー'}</span>
          </button>
        );
      }

      // Preset Card component
      function PresetCard({ preset, onCopy, onLike, fav, onFav, liked }) {
        const [open, setOpen] = useState(false);
        return (
          <Glass>
            <div className="grid md:grid-cols-3 gap-0 overflow-hidden rounded-xl">
              <div className="relative md:col-span-1">
                <img src={preset.image} alt={preset.name} className="w-full h-full object-cover rounded-xl md:rounded-l-xl" />
                <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent text-white p-3 rounded-b-xl md:rounded-bl-xl md:rounded-br-none">
                  <h3 className="text-lg font-semibold">{preset.name}</h3>
                  <p className="text-xs opacity-90">{preset.title}</p>
                </div>
              </div>
              <div className="md:col-span-2 p-5">
                <div className="flex flex-wrap items-center gap-2 text-xs text-gray-600 dark:text-gray-300">
                  <span className="inline-flex items-center gap-1"><HeartHandshake className="h-4 w-4"/> {preset.persona}</span>
                  <span className="px-2 py-0.5 rounded-full border">MBTI: {preset.mbti}</span>
                  <span className="px-2 py-0.5 rounded-full border">{preset.gender}</span>
                  <span className="px-2 py-0.5 rounded-full border">口調: {preset.tone}</span>
                  <span className="px-2 py-0.5 rounded-full border">雰囲気: {preset.brightness}</span>
                </div>
                <p className="text-sm text-gray-700 dark:text-gray-200 mt-3">特徴: {preset.traits}</p>
                <p className="text-sm text-gray-700 dark:text-gray-200">目的: {preset.goal}</p>
                <div className="flex flex-wrap gap-2 my-3">
                  {preset.tags.map((t) => (
                    <span key={t} className="px-2 py-1 rounded-full text-xs bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300">#{t}</span>
                  ))}
                </div>
                <div className="flex items-center gap-2">
                  <button
                    onClick={onLike}
                    className={classNames(
                      'inline-flex items-center gap-1 rounded-lg border px-3 py-1.5 text-sm bg-white/70 dark:bg-white/10 hover:bg-white/90 dark:hover:bg-white/20',
                      liked ? 'text-red-500' : ''
                    )}
                  >
                    <Heart className="h-4 w-4" fill={liked ? 'currentColor' : 'none'} /> {preset.likes}
                  </button>
                  <CopyButton text={preset.starterPrompt} onCopied={onCopy} />
                  <button
                    onClick={() => setOpen((o) => !o)}
                    className="inline-flex items                                                                                                                                                                                                                                                                