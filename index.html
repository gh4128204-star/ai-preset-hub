<!DOCTYPE html>
<html lang="ja" class="">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¼šè©±ç›¸æ‰‹AIãƒ—ãƒªã‚»ãƒƒãƒˆãƒ»ãƒãƒ–</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.39.4/dist/umd/supabase.js"></script>
  <style>
    /* Dark mode support: toggle on <html> element */
    :root { color-scheme: light dark; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-200">
  <!-- Header -->
  <header class="sticky top-0 z-20 bg-white/80 dark:bg-gray-800/80 backdrop-blur border-b border-gray-200 dark:border-gray-700">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl sm:text-2xl font-bold">ä¼šè©±ç›¸æ‰‹AIãƒ—ãƒªã‚»ãƒƒãƒˆãƒ»ãƒãƒ–</h1>
      <div class="flex items-center space-x-2">
        <button id="openModalBtn" class="px-3 py-1.5 text-sm rounded border bg-white dark:bg-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600">æŠ•ç¨¿ã™ã‚‹</button>
        <button id="themeToggle" class="px-3 py-1.5 text-sm rounded border bg-white dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600">ãƒ†ãƒ¼ãƒ</button>
      </div>
    </div>
  </header>
  <!-- Main content -->
  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Search & sort -->
    <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
      <input id="searchInput" type="text" placeholder="æ¤œç´¢: åå‰ / ç‰¹å¾´ / MBTI / å½¹å‰²" class="flex-1 border rounded-xl px-3 py-2" />
      <select id="sortSelect" class="border rounded-xl px-3 py-2">
        <option value="popular">äººæ°—é †</option>
        <option value="newest">æ–°ç€é †</option>
        <option value="copies">ã‚³ãƒ”ãƒ¼æ•°</option>
      </select>
    </div>
    <!-- Tag filter -->
    <div id="tagFilter" class="flex flex-wrap gap-2 my-4"></div>
    <!-- Presets list -->
    <div id="presetsList" class="grid gap-4 md:grid-cols-2"></div>
  </main>
  <!-- Footer -->
  <footer class="text-center text-xs text-gray-500 dark:text-gray-400 py-8">&copy; <span id="year"></span> Conversation Partner Preset Hub</footer>
  <!-- Modal for posting -->
  <div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-2xl overflow-y-auto max-h-screen">
      <div class="flex justify-between mb-4">
        <h2 class="text-lg font-semibold">æ–°è¦ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’æŠ•ç¨¿</h2>
        <button id="closeModalBtn" class="text-sm px-2 py-1 rounded border">é–‰ã˜ã‚‹</button>
      </div>
      <form id="postForm" class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
        <label class="grid gap-1">
          <span class="text-xs text-gray-500">åå‰*</span>
          <input name="name" required class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" />
        </label>
        <label class="grid gap-1">
          <span class="text-xs text-gray-500">ã‚¿ã‚¤ãƒˆãƒ«</span>
          <input name="title" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" />
        </label>
        <label class="grid gap-1">
          <span class="text-xs text-gray-500">ç”»åƒURL</span>
          <input name="image" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="https://..." />
        </label>
        <!-- ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: ã“ã“ã§ãƒ­ãƒ¼ã‚«ãƒ«ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã§ãã¾ã™ã€‚å…¥åŠ›ãŒã‚ã‚‹å ´åˆã¯URLã‚ˆã‚Šå„ªå…ˆã•ã‚Œã¾ã™ -->
        <label class="grid gap-1">
          <span class="text-xs text-gray-500">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«</span>
          <input type="file" name="imageFile" accept="image/*" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" />
        </label>
        <label class="grid gap-1">
          <span class="text-xs text-gray-500">MBTI</span>
          <input name="mbti" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="ä¾‹: ENFP" />
        </label>
        <label class="grid gap-1">
          <span class="text-xs text-gray-500">æ€§åˆ¥</span>
          <input name="gender" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="ç”·æ€§/å¥³æ€§/ãã®ä»–/æœªè¨­å®š" />
        </label>
        <label class="grid gap-1">
          <span class="text-xs text-gray-500">å£èª¿</span>
          <input name="tone" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="ä¸å¯§/ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«/å³ã—ã‚ ç­‰" />
        </label>
        <label class="grid gap-1">
          <span class="text-xs text-gray-500">é›°å›²æ°—</span>
          <input name="brightness" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="æ˜ã‚‹ã‚/è½ã¡ç€ã ç­‰" />
        </label>
        <label class="grid gap-1 sm:col-span-2">
          <span class="text-xs text-gray-500">ç›®çš„</span>
          <input name="goal" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="ç›¸è«‡/é›‘è«‡/å­¦ç¿’ ç­‰" />
        </label>
        <label class="grid gap-1 sm:col-span-2">
          <span class="text-xs text-gray-500">ç‰¹å¾´</span>
          <textarea name="traits" rows="2" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="ä¾‹: å„ªã—ã„ãƒ»å…±æ„Ÿçš„ãƒ»èãä¸Šæ‰‹"></textarea>
        </label>
        <label class="grid gap-1 sm:col-span-2">
          <span class="text-xs text-gray-500">ãƒšãƒ«ã‚½ãƒŠæ¦‚è¦</span>
          <textarea name="persona" rows="2" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="1-3æ–‡ã§"></textarea>
        </label>
        <label class="grid gap-1 sm:col-span-2">
          <span class="text-xs text-gray-500">ã‚¿ã‚° (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</span>
          <input name="tags" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="å„ªã—ã„,å…±æ„Ÿ,ç›¸è«‡" />
        </label>
        <label class="grid gap-1 sm:col-span-2">
          <span class="text-xs text-gray-500">ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ*</span>
          <textarea name="starterPrompt" rows="3" required class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ã§ãã‚‹æŒ‡ç¤ºæ–‡"></textarea>
        </label>
        <!-- ã‚µãƒ³ãƒ—ãƒ«ä¼šè©±ã‚’1ã¤ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«çµ±åˆ -->
        <label class="grid gap-1 sm:col-span-2">
          <span class="text-xs text-gray-500">ã‚µãƒ³ãƒ—ãƒ«ä¼šè©±</span>
          <textarea name="sampleConversation" rows="4" class="w-full rounded-xl border px-3 py-2 bg-white/80 dark:bg-gray-700" placeholder="ä¾‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨AIã®ä¼šè©±ã‚’è‡ªç”±ã«è¨˜å…¥"></textarea>
        </label>
      </form>
      <div class="mt-4 flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
        <span>â€» ç”»åƒã¯æ¨©åˆ©ã«æ³¨æ„ã€‚æŠ•ç¨¿ã¯åˆ©ç”¨è¦ç´„/ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¯¾è±¡ã€‚</span>
        <button id="submitBtn" class="px-4 py-2 text-sm rounded bg-black text-white dark:bg-white dark:text-black">æŠ•ç¨¿ã™ã‚‹</button>
      </div>
    </div>
  </div>
  <!-- Script -->
  <script>
    (() => {
      // Supabase connection: embed the provided credentials
      const SUPABASE_URL = 'https://izmqiahahcsifhjtpgtd.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6bXFpYWhhaGNzaWZoanRwZ3RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MTI4NDIsImV4cCI6MjA3NDI4ODg0Mn0.LNnuAlfOekakZCVyGC7IA_NgYfy1BGe34PcxS8miAMw';
      const supabase = (typeof window.supabase !== 'undefined') ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
      // Local storage helpers
      const getLS = (key, def) => {
        try { const s = localStorage.getItem(key); return s ? JSON.parse(s) : def; } catch (e) { return def; }
      };
      const setLS = (key, val) => {
        try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
      };
      // Seeds for fallback
      const seeds = [
        {
          id: 'yukari',
          name: 'ã‚†ã‹ã‚Š',
          title: 'å„ªã—ã„èãå½¹ã®å‹äºº',
          image: 'https://images.unsplash.com/photo-1560250097-0b93528c311a?auto=format&fit=crop&w=800&q=60',
          persona: 'ç›¸æ‰‹ã®æ°—æŒã¡ã«å¯„ã‚Šæ·»ã†ç™’ã‚„ã—ç³»ã€‚å®‰å¿ƒã—ã¦è©±ã›ã‚‹é›°å›²æ°—ã‚’ã¤ãã‚‹ã€‚',
          traits: 'å„ªã—ã„ãƒ»å…±æ„Ÿçš„ãƒ»èãä¸Šæ‰‹',
          goal: 'æ„Ÿæƒ…æ•´ç†ï¼å®‰å¿ƒã—ã¦è©±ã™',
          mbti: 'ISFJ',
          gender: 'å¥³æ€§',
          tone: 'ä¸å¯§/ã‚„ã‚ã‚‰ã‹',
          brightness: 'æ˜ã‚‹ã‚',
          tags: ['å„ªã—ã„','å…±æ„Ÿ','ç›¸è«‡'],
          starterPrompt: 'ã‚ãªãŸã¯ã€Œå„ªã—ã„èãå½¹ã®å‹äººã€ã§ã™ã€‚\n- å…±æ„Ÿâ†’è¦ç´„â†’ã‚ªãƒ¼ãƒ—ãƒ³è³ªå•ã®é †ã§é€²ã‚ã‚‹\n- è©•ä¾¡ã‚„æ–­å®šã¯é¿ã‘ã‚‹\n- å¿…è¦ãªã¨ãã ã‘ææ¡ˆã‚’1ã¤ã¾ã§',
          sampleDialog: [
            { role: 'user', text: 'ç ”ç©¶ãŒé€²ã¾ãªãã¦ç„¦ã‚‹ã€‚' },
            { role: 'assistant', text: 'ç„¦ã‚ŠãŒå¼·ã„ã‚“ã ã­ã€‚ã©ã®å ´é¢ã§ä¸€ç•ªå¼·ãå‡ºã‚‹ï¼Ÿä¸€ç·’ã«åŒºåˆ‡ã£ã¦è€ƒãˆã¦ã¿ã‚ˆã†ã€‚' }
          ],
          likes: 21, copies: 58, createdAt: Date.now() - 1000 * 60 * 60 * 24 * 9
        },
        {
          id: 'takeshi',
          name: 'ãŸã‘ã—',
          title: 'ã‚¹ãƒˆã‚¤ãƒƒã‚¯ç¾å®Ÿã‚³ãƒ¼ãƒ',
          image: 'https://images.unsplash.com/photo-1519345182560-3f2917c472ef?auto=format&fit=crop&w=800&q=60',
          persona: 'é æ…®ãªãæ ¸å¿ƒã‚’çªãã€‚ç›®æ¨™é”æˆã®ãŸã‚ã«æœ€çŸ­ã®è¡Œå‹•ã‚’ç¤ºã™ã€‚',
          traits: 'å³ã—ã‚ãƒ»è«–ç†çš„ãƒ»çŸ­æ–‡',
          goal: 'æ„æ€æ±ºå®šï¼è¡Œå‹•è¨ˆç”»',
          mbti: 'ENTJ',
          gender: 'ç”·æ€§',
          tone: 'æ–­å®š/ç°¡æ½”',
          brightness: 'ä¸­åº¸',
          tags: ['å³ã—ã‚','è«–ç†','ã‚³ãƒ¼ãƒãƒ³ã‚°'],
          starterPrompt: 'ã‚ãªãŸã¯ã€Œã‚¹ãƒˆã‚¤ãƒƒã‚¯ãªç¾å®Ÿã‚³ãƒ¼ãƒã€ã§ã™ã€‚\n- å½¢å¼: çµè«–(1è¡Œ)â†’ç†ç”±(æœ€å¤§3)â†’æ¬¡ã®3ã‚¹ãƒ†ãƒƒãƒ—\n- è¿·ã„ãŒå¤šã„å ´åˆã¯åˆ¤æ–­è»¸ã‚’3ã¤ã«é™å®š\n- åŒ»ç™‚/æ³•å¾‹/æŠ•è³‡ã¯ä¸€èˆ¬æƒ…å ±ã®ã¿',
          sampleDialog: [
            { role: 'user', text: 'è»¢è·è¿·ã„ä¸­ã€‚æ±ºã‚ãã‚Œãªã„ã€‚' },
            { role: 'assistant', text: 'çµè«–: ä»Šé€±æœ«ã«æ±ºã‚ã‚ã€‚ç†ç”±: æƒ…å ±éå¤š/è»¸ä¸æ˜/æœŸé™ç„¡ã€‚æ¬¡ã®3ã‚¹ãƒ†ãƒƒãƒ—: è»¸=å¹´å/è£é‡/æˆé•·ã€5æ®µéšæ¯”è¼ƒã€æ—¥æ›œ18æ™‚ã«çµè«–ã€‚' }
          ],
          likes: 35, copies: 92, createdAt: Date.now() - 1000 * 60 * 60 * 24 * 6
        }
      ];
      // State
      let presets = [];
      let likes = getLS('cpp_likes', {});
      let copies = getLS('cpp_copies', {});
      let favorites = getLS('cpp_fav', {});
      let searchQuery = '';
      let selectedTags = [];
      let sortMode = 'popular';
      // Elements
      const listEl = document.getElementById('presetsList');
      const tagFilterEl = document.getElementById('tagFilter');
      const searchInput = document.getElementById('searchInput');
      const sortSelect = document.getElementById('sortSelect');
      const modal = document.getElementById('modal');
      const openModalBtn = document.getElementById('openModalBtn');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const postForm = document.getElementById('postForm');
      const submitBtn = document.getElementById('submitBtn');
      const themeToggle = document.getElementById('themeToggle');
      // Load initial data
      async function loadPresets() {
        presets = [...seeds];
        if (supabase) {
          try {
            const { data, error } = await supabase
              .from('presets')
              .select('*')
              .eq('status', 'public')
              .order('created_at', { ascending: false });
            if (!error && Array.isArray(data)) {
              const converted = data.map((row) => ({
                id: row.id || Math.random().toString(36).slice(2),
                name: row.name,
                title: row.title,
                image: row.image_url || '',
                persona: row.persona,
                traits: row.traits,
                goal: row.goal,
                mbti: row.mbti,
                gender: row.gender,
                tone: row.tone,
                brightness: row.brightness,
                tags: row.tags || [],
                starterPrompt: row.prompt,
                sampleDialog: row.sample || [],
                likes: 0,
                copies: 0,
                createdAt: new Date(row.created_at).getTime(),
              }));
              presets = [...converted, ...presets];
            }
          } catch (e) {
            console.warn('Supabaseã‹ã‚‰ã®å–å¾—ã«å¤±æ•—', e);
          }
        }
        render();
        updateTagFilter();
      }
      // Render presets list
      function render() {
        const filtered = presets.filter((p) => {
          const q = searchQuery.trim().toLowerCase();
          const qHit = !q || [p.name, p.title, p.persona, p.traits, p.goal, p.mbti, p.tone].join(' ').toLowerCase().includes(q);
          const tagHit = selectedTags.length === 0 || selectedTags.every((t) => p.tags.includes(t));
          return qHit && tagHit;
        }).sort((a, b) => {
          if (sortMode === 'popular') {
            const aScore = (a.likes || 0) + (a.copies || 0);
            const bScore = (b.likes || 0) + (b.copies || 0);
            return bScore - aScore;
          }
          if (sortMode === 'newest') {
            return b.createdAt - a.createdAt;
          }
          if (sortMode === 'copies') {
            return (b.copies || 0) - (a.copies || 0);
          }
          return 0;
        });
        listEl.innerHTML = '';
        if (filtered.length === 0) {
          listEl.innerHTML = '<div class="text-gray-500 dark:text-gray-400 py-12">è©²å½“ã™ã‚‹ãƒ—ãƒªã‚»ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
          return;
        }
        filtered.forEach((p) => {
          const card = document.createElement('div');
          // ãŠæ°—ã«å…¥ã‚Šã®å ´åˆã¯é’ã„æ ã‚’ä»˜ã‘ã‚‹
          card.className = 'rounded-2xl overflow-hidden shadow-md flex flex-col md:flex-row ' + (favorites[p.id] ? 'border-blue-500' : 'border');
          // Image
          const imgDiv = document.createElement('div');
          imgDiv.className = 'md:w-1/3 h-40 md:h-auto overflow-hidden';
          const img = document.createElement('img');
          img.src = p.image || 'https://placehold.co/400x300?text=No+Image';
          img.alt = p.name;
          img.className = 'object-cover w-full h-full';
          imgDiv.appendChild(img);
          // Content
          const cont = document.createElement('div');
          cont.className = 'p-4 flex-1 flex flex-col';
          const header = document.createElement('div');
          header.className = 'flex justify-between items-start mb-2';
          const nameEl = document.createElement('div');
          nameEl.innerHTML = `<h3 class="text-lg font-semibold">${p.name}</h3><p class="text-xs text-gray-600 dark:text-gray-300">${p.title || ''}</p>`;
          header.appendChild(nameEl);
          const saveBtn = document.createElement('button');
          saveBtn.className = 'text-xs px-2 py-1 rounded border';
          saveBtn.textContent = favorites[p.id] ? 'ä¿å­˜æ¸ˆ' : 'ä¿å­˜';
          saveBtn.addEventListener('click', () => {
            // ãŠæ°—ã«å…¥ã‚ŠçŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«
            favorites[p.id] = !favorites[p.id];
            setLS('cpp_fav', favorites);
            // å…¨ä½“ã‚’å†æç”»ã—ã¦ãƒœã‚¿ãƒ³æ–‡å­—ã¨ã‚«ãƒ¼ãƒ‰æ ã‚’æ›´æ–°
            render();
          });
          header.appendChild(saveBtn);
          cont.appendChild(header);
          // Persona & meta
          const meta = document.createElement('div');
          meta.className = 'flex flex-wrap gap-2 text-xs text-gray-600 dark:text-gray-300 mb-2';
          meta.innerHTML =
            `<span>${p.persona}</span>` +
            (p.mbti ? `<span class="px-2 py-0.5 border rounded">MBTI: ${p.mbti}</span>` : '') +
            (p.gender ? `<span class="px-2 py-0.5 border rounded">${p.gender}</span>` : '') +
            (p.tone ? `<span class="px-2 py-0.5 border rounded">å£èª¿: ${p.tone}</span>` : '') +
            (p.brightness ? `<span class="px-2 py-0.5 border rounded">é›°å›²æ°—: ${p.brightness}</span>` : '');
          cont.appendChild(meta);
          // Traits and goal
          if (p.traits) {
            const traitsEl = document.createElement('p');
            traitsEl.className = 'text-sm mb-1';
            traitsEl.textContent = `ç‰¹å¾´: ${p.traits}`;
            cont.appendChild(traitsEl);
          }
          if (p.goal) {
            const goalEl = document.createElement('p');
            goalEl.className = 'text-sm mb-1';
            goalEl.textContent = `ç›®çš„: ${p.goal}`;
            cont.appendChild(goalEl);
          }
          // Tags
          if (p.tags && p.tags.length) {
            const tagsDiv = document.createElement('div');
            tagsDiv.className = 'flex flex-wrap gap-1 mb-2';
            p.tags.forEach((t) => {
              const tag = document.createElement('span');
              tag.className = 'px-2 py-0.5 bg-gray-100 dark:bg-gray-700 text-xs rounded';
              tag.textContent = `#${t}`;
              tagsDiv.appendChild(tag);
            });
            cont.appendChild(tagsDiv);
          }
          // Buttons
          const btnRow = document.createElement('div');
          btnRow.className = 'mt-auto flex flex-wrap items-center gap-2 text-xs';
          // Like button
          const likeBtn = document.createElement('button');
          likeBtn.className = 'flex items-center gap-1 px-3 py-1 rounded border';
          likeBtn.innerHTML = `â¤ ${p.likes || 0}`;
          if (likes[p.id]) {
            likeBtn.classList.add('text-red-600');
          }
          likeBtn.addEventListener('click', () => {
            if (likes[p.id]) {
              // toggle off
              delete likes[p.id];
              p.likes = Math.max(0, (p.likes || 0) - 1);
              likeBtn.classList.remove('text-red-600');
            } else {
              likes[p.id] = true;
              p.likes = (p.likes || 0) + 1;
              likeBtn.classList.add('text-red-600');
            }
            setLS('cpp_likes', likes);
            likeBtn.innerHTML = `â¤ ${p.likes}`;
            render();
          });
          btnRow.appendChild(likeBtn);
          // Copy button
          const copyBtn = document.createElement('button');
          copyBtn.className = 'flex items-center gap-1 px-3 py-1 rounded border';
          copyBtn.innerHTML = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼';
          copyBtn.addEventListener('click', async () => {
            try {
              await navigator.clipboard.writeText(p.starterPrompt);
              // ã‚³ãƒ”ãƒ¼å›æ•°ã‚’å¢—ã‚„ã™ï¼ˆ1ã‚¯ãƒªãƒƒã‚¯ã”ã¨ã«ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ï¼‰
              p.copies = (p.copies || 0) + 1;
              // ã‚³ãƒ”ãƒ¼çŠ¶æ…‹ã‚’ä¿å­˜ï¼ˆè¤‡æ•°å›ã‚³ãƒ”ãƒ¼å¯ï¼‰
              copies[p.id] = true;
              setLS('cpp_copies', copies);
              // ä¸€æ™‚çš„ã«ã‚³ãƒ”ãƒ¼æ¸ˆã¿ã¨è¡¨ç¤º
              copyBtn.innerHTML = 'âœ” ã‚³ãƒ”ãƒ¼æ¸ˆã¿';
              // 1ç§’å¾Œã«å…ƒã«æˆ»ã™
              setTimeout(() => { copyBtn.innerHTML = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼'; }, 1200);
              render();
            } catch (e) {
              console.warn('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—', e);
            }
          });
          btnRow.appendChild(copyBtn);
          // Toggle prompt
          const toggleBtn = document.createElement('button');
          toggleBtn.className = 'px-3 py-1 rounded border';
          toggleBtn.textContent = 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¦‹ã‚‹';
          btnRow.appendChild(toggleBtn);
          cont.appendChild(btnRow);
          // Hidden prompt
          const promptDiv = document.createElement('div');
          promptDiv.className = 'mt-2 text-xs bg-gray-50 dark:bg-gray-700 rounded p-3 border hidden whitespace-pre-wrap';
          // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¸‹ã«ã‚µãƒ³ãƒ—ãƒ«ä¼šè©±ã‚’è¡¨ç¤ºã€‚sampleConversationãŒã‚ã‚Œã°ãã‚Œã‚’ã€ãã®æ¬¡ã«å¾“æ¥ã®sampleDialogå½¢å¼ã«ã‚‚å¯¾å¿œ
          let sampleText = '';
          if (p.sampleConversation) {
            sampleText = p.sampleConversation;
          } else if (p.sampleDialog && Array.isArray(p.sampleDialog) && p.sampleDialog.length) {
            sampleText = p.sampleDialog.map((d) => {
              const prefix = d.role === 'user' ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼: ' : d.role === 'assistant' ? 'AI: ' : '';
              return prefix + d.text;
            }).join('\n');
          }
          promptDiv.textContent = p.starterPrompt + '\n\n' + sampleText;
          cont.appendChild(promptDiv);
          toggleBtn.addEventListener('click', () => {
            const isOpen = !promptDiv.classList.contains('hidden');
            promptDiv.classList.toggle('hidden');
            toggleBtn.textContent = isOpen ? 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¦‹ã‚‹' : 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’éš ã™';
          });
          // Append to card
          card.appendChild(imgDiv);
          card.appendChild(cont);
          listEl.appendChild(card);
        });
      }
      function updateTagFilter() {
        const all = new Set();
        presets.forEach((p) => (p.tags || []).forEach((t) => all.add(t)));
        const tags = Array.from(all).sort();
        tagFilterEl.innerHTML = '';
        if (tags.length === 0) return;
        tags.forEach((t) => {
          const chip = document.createElement('button');
          chip.className = 'px-2 py-1 rounded-full border text-xs ' + (selectedTags.includes(t) ? 'bg-black text-white dark:bg-white dark:text-black' : 'bg-white dark:bg-gray-700');
          chip.textContent = '#' + t;
          chip.addEventListener('click', () => {
            if (selectedTags.includes(t)) {
              selectedTags = selectedTags.filter((x) => x !== t);
            } else {
              selectedTags.push(t);
            }
            render();
            updateTagFilter();
          });
          tagFilterEl.appendChild(chip);
        });
        if (selectedTags.length > 0) {
          const clearBtn = document.createElement('button');
          clearBtn.className = 'px-2 py-1 rounded-full border text-xs bg-red-100 dark:bg-red-700 text-red-600';
          clearBtn.textContent = 'ã‚¯ãƒªã‚¢';
          clearBtn.addEventListener('click', () => {
            selectedTags = [];
            render();
            updateTagFilter();
          });
          tagFilterEl.appendChild(clearBtn);
        }
      }
      // Event listeners
      searchInput.addEventListener('input', (e) => {
        searchQuery = e.target.value;
        render();
      });
      sortSelect.addEventListener('change', (e) => {
        sortMode = e.target.value;
        render();
      });
      openModalBtn.addEventListener('click', () => { modal.classList.remove('hidden'); });
      closeModalBtn.addEventListener('click', () => { modal.classList.add('hidden'); });
      submitBtn.addEventListener('click', async () => {
        const formData = new FormData(postForm);
        const payload = {
          id: 'id-' + Math.random().toString(36).slice(2),
          name: formData.get('name').trim(),
          title: formData.get('title').trim(),
          image: formData.get('image').trim(),
          persona: formData.get('persona').trim(),
          traits: formData.get('traits').trim(),
          goal: formData.get('goal').trim(),
          mbti: formData.get('mbti').trim(),
          gender: formData.get('gender').trim(),
          tone: formData.get('tone').trim(),
          brightness: formData.get('brightness').trim(),
          tags: formData.get('tags').split(',').map((s) => s.trim()).filter(Boolean),
          starterPrompt: formData.get('starterPrompt').trim(),
          // ã‚µãƒ³ãƒ—ãƒ«ä¼šè©±ã¯1ã¤ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡Œã”ã¨ã«åˆ†å‰²ã—ã¦é…åˆ—åŒ–ã—ã€è¡¨ç¤ºç”¨ã«æ–‡å­—åˆ—ã‚‚ä¿æŒ
          sampleConversation: formData.get('sampleConversation').trim(),
          sampleDialog: (() => {
            const txt = formData.get('sampleConversation').trim();
            if (!txt) return [];
            return txt.split('\n').map((line) => ({ role: 'user', text: line }));
          })(),
          likes: 0,
          copies: 0,
          createdAt: Date.now(),
        };
        // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’DataURLã«å¤‰æ›ã—ã¦URLå…¥åŠ›ã‚ˆã‚Šå„ªå…ˆã—ã¾ã™
        const imageFile = formData.get('imageFile');
        if (imageFile && imageFile instanceof File && imageFile.size > 0) {
          try {
            const dataUrl = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result);
              reader.onerror = (err) => reject(err);
              reader.readAsDataURL(imageFile);
            });
            payload.image = dataUrl;
          } catch (e) {
            console.warn('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', e);
          }
        }
        if (!payload.name || !payload.starterPrompt) {
          alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        // Insert into Supabase if available
        if (supabase) {
          try {
            const { error } = await supabase.from('presets').insert({
              name: payload.name,
              title: payload.title,
              image_url: payload.image,
              persona: payload.persona,
              traits: payload.traits,
              goal: payload.goal,
              mbti: payload.mbti,
              gender: payload.gender,
              tone: payload.tone,
              brightness: payload.brightness,
              tags: payload.tags,
              prompt: payload.starterPrompt,
              sample: payload.sampleDialog,
              status: 'public',
            });
            if (error) throw error;
          } catch (e) {
            console.warn('Supabaseä¿å­˜ã«å¤±æ•—ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿', e);
          }
        }
        // Insert locally and re-render
        presets.unshift(payload);
        render();
        updateTagFilter();
        postForm.reset();
        modal.classList.add('hidden');
      });
      // Theme toggle
      themeToggle.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
      });
      // Set current year
      document.getElementById('year').textContent = new Date().getFullYear();
      // Load presets
      loadPresets();
    })();
  </script>
</body>
</html>